# Туториал по планированию в SAMPO

## Оглавление

* [1. Подготовка графа работ и подрядчиков](#1-подготовка-графа-работ-и-подрядчиков)

  * [1.1 Загрузка из CSV](#11-загрузка-из-csv)
  * [1.2 Загрузка из сериализованного JSON](#12-загрузка-из-сериализованного-json)

    * [1.2.1 WorkGraph → DataFrame](#121-workgraph--dataframe)
    * [1.2.2 Автоподбор подрядчиков по WorkGraph](#122-автоподбор-подрядчиков-по-workgraph)
    * [1.2.3 Загрузка расписания из JSON](#123-загрузка-расписания-из-json)
  * [1.x Интеграция в STAIRS](#1x-интеграция-в-stairs)
* [2. Инициализация алгоритмов планирования](#2-инициализация-алгоритмов-планирования)

  * [2.1 Пользовательский WorkTimeEstimator](#21-пользовательский-worktimeestimator)
  * [2.2 Эвристические и топологические планировщики](#22-эвристические-и-топологические-планировщики)
  * [2.3 Генетический алгоритм: гиперпараметры](#23-генетический-алгоритм-гиперпараметры)
* [3. Построение расписания через пайплайн](#3-построение-расписания-через-пайплайн)

  * [3.1 Настройка пайплайна](#31-настройка-пайплайна)

    * [3.1.1 Восстановление структуры и лагов по истории](#311-восстановление-структуры-и-лагов-по-истории)
    * [3.1.2 Передача подрядчиков](#312-передача-подрядчиков)
    * [3.1.3 Передача исторических данных](#313-передача-исторических-данных)
    * [3.1.4 Реструктуризация графа](#314-реструктуризация-графа)
    * [3.1.5 Подключение оценщика времени](#315-подключение-оценщика-времени)
    * [3.1.6 Построение расписания](#316-построение-расписания)
  * [3.2 Полное планирование и экспорт](#32-полное-планирование-и-экспорт)

## 1. Подготовка графа работ и подрядчиков

### 1.1 Загрузка из CSV

* Используются колонки по работам и связям.
* Для связей задаются `predecessor_ids`, типы соединений и лаги.
* При восстановлении связей по истории допустим минимальный набор полей.

### 1.2 Загрузка из сериализованного JSON

* Импорт проекта целиком: структура `WorkGraph` и, при наличии, `Schedule`.
* Удобно для повторной визуализации и сравнения.

#### 1.2.1 WorkGraph → DataFrame

* Из `ScheduleProject` извлекается `WorkGraph`.
* Преобразование графа в `pandas.DataFrame` для анализа и восстановления лагов.

#### 1.2.2 Автоподбор подрядчиков по WorkGraph

* Формирование списка подрядчиков по потребностям графа.
* Учитываются требуемые ресурсы и специализации.

#### 1.2.3 Загрузка расписания из JSON

* Из сериализованного файла извлекается объект `Schedule`.
* Подходит для сравнения с новыми расчётами.

### 1.x Интеграция в STAIRS

* Источники: CSV, БД (`postgresql_url`), сериализованный проект.
* После `.finish()` доступен `ScheduleProject`; из него получают `Schedule` и `wg.to_frame(save_req=True)` для СППР.

## 2. Инициализация алгоритмов планирования

### 2.1 Пользовательский WorkTimeEstimator

* Своя модель длительностей и ресурсов, например `FieldDevWorkEstimator`.
* Один экземпляр используется всеми планировщиками.

### 2.2 Эвристические и топологические планировщики

* `HEFTScheduler`, `HEFTBetweenScheduler`, `TopologicalScheduler`, `RandomizedTopologicalScheduler`.
* Не требуют сложной настройки.

### 2.3 Генетический алгоритм: гиперпараметры

* `GeneticScheduler` с авто-подбором поколений или явными параметрами.
* Проверка настроек на малых примерах перед основным запуском.

## 3. Построение расписания через пайплайн

### 3.1 Настройка пайплайна

* Последовательная передача графа, подрядчиков, истории и оценщика.
* Опционально: `LagOptimizationStrategy`.

#### 3.1.1 Восстановление структуры и лагов по истории

* Использование `DataFrame` из `WorkGraph`.
* Восстановление типов связей и лагов по истории.

#### 3.1.2 Передача подрядчиков

* В пайплайн передаётся список подрядчиков.
* Возможен автоподбор по `WorkGraph`.

#### 3.1.3 Передача исторических данных

* Загрузка `history_df` из CSV.
* История учитывается при реструктуризации и оценке времени.

#### 3.1.4 Реструктуризация графа

* Нормализация структуры работ с учётом истории и ресурсов.
* Результат — обновлённый `DataFrame`.

#### 3.1.5 Подключение оценщика времени

* Подключение пользовательской модели для длительностей и ресурсов.
* Единый оценщик на всех этапах.

#### 3.1.6 Построение расписания

* Запуск выбранного планировщика (`HEFT*`, `Topological*`, `GeneticScheduler`).
* На выходе `ScheduleProject` и `Schedule`; поддерживается визуализация (`schedule_gant_chart_fig`, `VisualizationMode`).

### 3.2 Полное планирование и экспорт

* Сквозной прогон через `SchedulingPipeline.create() … .finish()[0]`.
* Просмотр структуры графа, получение `Schedule`, экспорт в JSON для дальнейшей загрузки в СППР.
